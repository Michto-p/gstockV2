rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return signedIn() ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data : null;
    }

    function roleId() {
      return userDoc().roleId;
    }

    function roleDoc() {
      return signedIn() ? get(/databases/$(database)/documents/roles/$(roleId())).data : null;
    }

    function approved() {
      return signedIn() && userDoc().approved == true && roleId() != "pending";
    }

    function perm(name) {
      return approved() && roleDoc().perms[name] == true;
    }

    function isOwner() {
      return signedIn() && request.auth.uid == "OWNER_UID_HERE";
    }

    function isAdmin() {
      return approved() && (roleId() == "admin" || roleDoc().perms.admin == true);
    }

    // USERS
    match /users/{uid} {
      allow read: if signedIn() && request.auth.uid == uid;

      // create: l'utilisateur peut créer son profil initial, mais pas s'auto-valider / s'auto-admin
      allow create: if signedIn() && request.auth.uid == uid
        && request.resource.data.approved == false
        && request.resource.data.roleId == "pending";

      // bootstrap owner (optionnel): peut se mettre admin/approved
      allow create: if isOwner() && request.auth.uid == uid;

      // update:
      // - l'utilisateur peut mettre à jour ses champs "soft" (displayName) mais pas approved/roleId
      // - admin peut modifier tout
      allow update: if isAdmin() || isOwner()
        || (signedIn() && request.auth.uid == uid
            && request.resource.data.approved == resource.data.approved
            && request.resource.data.roleId == resource.data.roleId
           );

      allow delete: if isAdmin();
    }

    // ROLES
    match /roles/{roleId} {
      allow read: if signedIn();
      allow write: if isAdmin(); // création / update / delete
    }

    // SUPPLIERS
    match /suppliers/{id} {
      allow read: if perm("read");
      allow write: if perm("suppliers") || isAdmin();
    }

    // ITEMS
    match /items/{barcode} {
      allow read: if perm("read");

      // création/modif article (champs) par items perm
      allow create, update, delete: if perm("items") || isAdmin();
    }

    // MOVES
    match /moves/{id} {
      allow read: if perm("read");
      allow create: if signedIn() && request.auth.uid == uid
        && request.resource.data.approved == false
        && request.resource.data.roleId == "pending";

      // bootstrap owner (optionnel): peut se mettre admin/approved
      allow create: if isOwner() && request.auth.uid == uid;
      allow update, delete: if isAdmin();
    }

    // fallback
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
