rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }
    function myUser() { return get(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function myRoleId() { return myUser().data.roleId; }
    function myRole() { return get(/databases/$(database)/documents/roles/$(myRoleId())); }
    function approved() { return myUser().data.approved == true; }
    function perm(p) { return signedIn() && approved() && myRole().data.perms[p] == true; }
    function isAdmin() { return signedIn() && approved() && (myRoleId() == "admin" || myRole().data.perms.admin == true); }

    match /roles/{rid} { allow read: if isAdmin() || perm("roles"); allow create, update, delete: if isAdmin() || perm("roles"); }
    match /users/{uid} { allow create: if signedIn() && request.auth.uid == uid; allow read: if (signedIn() && request.auth.uid == uid) || isAdmin() || perm("users"); allow update, delete: if isAdmin() || perm("users"); }
    match /suppliers/{id} { allow read: if perm("read"); allow create, update, delete: if isAdmin() || perm("suppliers"); }
    match /items/{barcode} { allow read: if perm("read"); allow create, update, delete: if isAdmin() || perm("items"); }
    match /moves/{id} { allow read: if perm("read"); allow create: if perm("move"); allow update, delete: if isAdmin(); }
  }
}
